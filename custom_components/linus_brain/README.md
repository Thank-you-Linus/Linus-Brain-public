# Linus Brain - Home Assistant Custom Integration

[![GitHub Release](https://img.shields.io/badge/version-0.1.0-blue.svg)](https://github.com/Thank-you-Linus/Linus-Brain)
[![License](https://img.shields.io/badge/license-MIT-green.svg)](LICENSE)

**Linus Brain** is an AI-powered Home Assistant custom integration that learns your home's movement patterns and generates intelligent automation rules.

> *"The smart, learning brain for your home"*

---

## 🎯 What is Linus Brain?

Linus Brain acts as an **AI bridge** between your Home Assistant and a cloud-based learning system (Supabase). It:

1. **Collects** movement-related signals from your home (motion, occupancy, media activity, lighting)
2. **Aggregates** this data by room with a computed movement score
3. **Sends** the data to Supabase for AI analysis
4. **Receives** automation rules generated by AI based on learned patterns
5. **Applies** these rules to create smart automations in your Home Assistant

---

## 🏗️ Architecture & Data Flow

```
┌─────────────────────────────────────────────────────────────────┐
│                     HOME ASSISTANT                               │
│                                                                   │
│  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐      │
│  │   Motion     │    │  Occupancy   │    │    Media     │      │
│  │   Sensors    │    │   Sensors    │    │   Players    │      │
│  └──────┬───────┘    └──────┬───────┘    └──────┬───────┘      │
│         │                   │                    │              │
│         └───────────────────┴────────────────────┘              │
│                             │                                    │
│                    ┌────────▼─────────┐                         │
│                    │  Linus Brain     │                         │
│                    │  Integration     │                         │
│                    │                  │                         │
│                    │  • Area Manager  │                         │
│                    │  • Event Listen  │                         │
│                    │  • Coordinator   │                         │
│                    └────────┬─────────┘                         │
│                             │                                    │
└─────────────────────────────┼────────────────────────────────────┘
                              │
                    HTTP POST │ (Presence Data)
                              │
                    ┌─────────▼──────────┐
                    │                    │
                    │     SUPABASE       │
                    │   (Cloud Brain)    │
                    │                    │
                    │  ┌──────────────┐  │
                    │  │ movement_data│  │
                    │  └──────────────┘  │
                    │                    │
                    └─────────┬──────────┘
                              │
                              │ AI Analysis
                              │ (External Agent)
                              │
                    ┌─────────▼──────────┐
                    │                    │
                    │  ┌──────────────┐  │
                    │  │automation    │  │
                    │  │rules         │  │
                    │  └──────────────┘  │
                    │                    │
                    └─────────┬──────────┘
                              │
                    HTTP GET  │ (Rules)
                              │
┌─────────────────────────────▼────────────────────────────────────┐
│                     HOME ASSISTANT                               │
│                                                                   │
│                    ┌──────────────┐                              │
│                    │ Rule Engine  │                              │
│                    │              │                              │
│                    │ Applies AI   │                              │
│                    │ Generated    │                              │
│                    │ Automations  │                              │
│                    └──────────────┘                              │
│                                                                   │
└───────────────────────────────────────────────────────────────────┘
```

---

## 📚 Documentation

### Core Guides

- **[Apps & Activities System](APPS_AND_ACTIVITIES.md)** - Complete guide to dynamic activities and automation apps (v2.0)
- **[Configuration Guide](CONFIGURATION.md)** - Detailed configuration options and setup
- **[Quick Start](QUICKSTART.md)** - Get started in 5 minutes

### Architecture

- **[Rule Format](RULE_FORMAT.md)** - Understanding automation rule structure
- **[Area State](AREA_STATE.md)** - Area state management and movement tracking

---

## 📊 Data Format

### Presence Data Sent to Supabase

```json
{
  "room": "salon",
  "timestamp": "2025-10-22T21:32:12Z",
  "entities": {
    "motion": "on",
    "movement": "off",
    "occupancy": "off",
    "media": "playing",
    "luminosity": 24.5
  },
  "movement_score": 0.75
}
```

### Presence Score Calculation

The movement score is a weighted sum (0-1) of:
- **Motion sensors**: 40% weight
- **Presence sensors**: 30% weight
- **Occupancy sensors**: 30% weight
- **Media players**: 25% weight
- **Luminosity**: 5% weight (inverted for evening movement)

### Light Action Data (Activity-Based Learning)

```json
{
  "instance_id": "uuid-of-ha-instance",
  "entity_id": "light.kitchen",
  "area": "kitchen",
  "action_type": "brightness",
  "activity": "occupied",
  "activity_duration": 127.3,
  "state": {
    "brightness": 204,
    "color_temp": 370
  },
  "context": {
    "movement_detected": true,
    "illuminance": 12.3,
    "sun_elevation": -8.5,
    "hour": 19,
    "day_of_week": 4
  },
  "timestamp": "2025-10-22T19:15:00Z"
}
```

**Action Types:**
- `turn_on` - Light was turned on
- `turn_off` - Light was turned off  
- `brightness` - Brightness was adjusted
- `color_temp` - Color temperature was changed
- `color` - RGB or HS color was changed

**Activity Levels:**
- `empty` - No movement detected in the area
- `movement` - Presence detected for less than 60 seconds
- `occupied` - Continuous movement for 60 seconds or more

**Activity Transitions:**
Activity levels automatically transition based on sensor states:
- Sensors activate → `empty` → `movement` (instant)
- Sensors stay active 60s → `movement` → `occupied` (after threshold)
- All sensors deactivate → `occupied/movement` → `empty` (instant)

These transitions can trigger automation rules, allowing different actions based on activity level. For example:
- `movement` detected + area is dark → Turn on lights at 50% brightness
- `occupied` detected + area is dark → Increase brightness to 80%
- Transition to `empty` → Turn off lights after delay

**Manual Detection:**
- Only captures actions with `user_id` in Home Assistant context
- Automatically filters out automations, scripts, and service calls
- Ensures learning is based on actual user preferences in real activity contexts

---

## 🚀 Features

### Current Features (v0.1.x)

- ✅ **Automatic entity discovery** by room (area)
- ✅ **Real-time monitoring** of motion, occupancy, media, and illuminance
- ✅ **Activity tracking** - Distinguishes 3 activity levels (empty, movement <60s, occupied ≥60s)
- ✅ **Event-driven updates** when entity states change
- ✅ **Periodic heartbeat** (every 15 minutes) to sync all room states
- ✅ **Presence score computation** using weighted signals
- ✅ **Activity-based light learning** - Captures manual light control patterns with activity context
  - Records brightness adjustments
  - Tracks color temperature changes
  - Captures RGB/HS color changes
  - Captures activity level and duration at time of action
  - Collects environmental context (movement, illuminance, sun elevation)
  - Stores temporal context (hour, day of week)
  - Filters automated actions (manual user interactions only)
- ✅ **Smart automation switches** - Only created for eligible areas (with both light entities and movement sensors)
- ✅ **Multi-instance support** - Unique UUID per Home Assistant installation
- ✅ **Async HTTP communication** with Supabase (non-blocking)
- ✅ **Diagnostic sensors** for monitoring integration health
- ✅ **UI-based configuration** via config flow
- ✅ **Comprehensive test coverage** (26+ unit tests)

### Future Features (Roadmap)

- 🔮 **AI rule generation** based on learned activity patterns
- 🔮 **Activity-based lighting automation** - Predict preferred brightness/color by activity level, duration, and context
- 🔮 **Automatic automation creation** from AI rules triggered by activity transitions
- 🔮 **Rule confidence scoring** and user feedback loop
- 🔮 **Activity pattern visualization** dashboard
- 🔮 **Adaptive learning** - Continuous refinement from user corrections and activity changes

---

## 📦 Installation

### HACS (Recommended)

1. Open HACS in Home Assistant
2. Go to "Integrations"
3. Click the three dots menu → "Custom repositories"
4. Add: `https://github.com/Thank-you-Linus/Linus-Brain`
5. Category: "Integration"
6. Search for "Linus Brain" and install

### Manual Installation

1. Copy the `custom_components/linus_brain` folder to your Home Assistant `config/custom_components/` directory
2. Restart Home Assistant
3. Go to Configuration → Integrations
4. Click "+ Add Integration"
5. Search for "Linus Brain"

---

## ⚙️ Configuration

### Prerequisites

1. **Supabase Project**: Create a free project at [supabase.com](https://supabase.com)
2. **Database Setup**: Run the complete schema from `supabase_setup.sql` in the repository, or create the required tables:

#### `ha_instances` table (Multi-instance support)

```sql
CREATE TABLE ha_instances (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    instance_name TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW()
);
```

#### `movement_data` table

```sql
CREATE TABLE movement_data (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    instance_id UUID REFERENCES ha_instances(id),
    room_id TEXT NOT NULL,
    room_name TEXT NOT NULL,
    movement_score NUMERIC(5,2) NOT NULL,
    motion_detected BOOLEAN,
    movement_detected BOOLEAN,
    occupancy_detected BOOLEAN,
    media_playing BOOLEAN,
    illuminance NUMERIC(10,2),
    entity_states JSONB,
    timestamp TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_movement_instance_room_time ON movement_data(instance_id, room_id, timestamp DESC);
CREATE INDEX idx_movement_score ON movement_data(movement_score);
```

#### `light_actions` table (Activity-based light learning)

```sql
CREATE TABLE light_actions (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    instance_id UUID REFERENCES ha_instances(id),
    entity_id TEXT NOT NULL,
    area TEXT,
    action_type TEXT NOT NULL,
    activity TEXT NOT NULL,
    activity_duration NUMERIC(10,1),
    state JSONB NOT NULL,
    context JSONB,
    timestamp TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_light_actions_instance_entity ON light_actions(instance_id, entity_id, timestamp DESC);
CREATE INDEX idx_light_actions_area ON light_actions(area, timestamp DESC);
CREATE INDEX idx_light_actions_activity ON light_actions(activity, timestamp DESC);
```

**Note:** The `activity` field stores one of: `empty`, `movement`, or `occupied`. The `activity_duration` field stores the duration in seconds of the current activity level.

#### `automation_rules` table (for future AI rules)

```sql
CREATE TABLE automation_rules (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    instance_id UUID REFERENCES ha_instances(id),
    rule_name TEXT NOT NULL,
    conditions JSONB NOT NULL,
    actions JSONB NOT NULL,
    priority INT DEFAULT 0,
    enabled BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

**Note:** Use the complete `supabase_setup.sql` file in the repository for the full schema with all indexes and constraints.

### Setup in Home Assistant

1. Go to **Configuration** → **Integrations**
2. Click **"+ Add Integration"**
3. Search for **"Linus Brain"**
4. Enter your Supabase credentials:
   - **Supabase URL**: Your project URL (e.g., `https://abcdefgh.supabase.co`)
   - **Supabase API Key**: Your `anon` or `service_role` key (see below)
5. Click **Submit**

The integration will validate the connection and create diagnostic sensors.

#### 🔑 API Key Selection

You can use either Supabase API key type:

**`anon` key (Recommended for Development):**
- ✅ Has built-in rate limits for safety
- ✅ Safer if accidentally exposed
- ✅ Sufficient permissions for this integration
- 📍 Found in: Supabase Dashboard → Settings → API → "anon public"

**`service_role` key (Recommended for Production):**
- ✅ Full database access
- ✅ No rate limits, better performance
- ⚠️ **Critical:** Must be kept secret (never expose client-side)
- ⚠️ Bypass all RLS policies - secure your network
- 📍 Found in: Supabase Dashboard → Settings → API → "service_role"

💡 **Quick Start:** Use the `anon` key to get started, switch to `service_role` later if needed.

#### 🔒 Row-Level Security (RLS)

If you encounter "new row violates row-level security policy" errors:

1. The integration includes RLS policies that work with both `anon` and `service_role` keys
2. If you set up your database before this version, run the `fix_rls_policies.sql` migration script
3. The script is located in the repository root and contains instructions

---

## 📱 Entities Created

After setup, you'll see these diagnostic entities:

### Sensors

- `sensor.linus_brain_last_sync`: Last successful sync with Supabase
- `sensor.linus_brain_monitored_rooms`: Number of rooms being monitored
- `sensor.linus_brain_errors`: Error count and success rate

### Buttons

- `button.linus_brain_sync_now`: Manually trigger immediate cloud synchronization

---

## 🔧 Monitored Entity Types

Linus Brain automatically discovers and monitors:

| Domain          | Device Class  | Purpose                            |
|-----------------|---------------|------------------------------------|
| `binary_sensor` | `motion`      | Detect movement                    |
| `binary_sensor` | `movement`    | Detect human movement              |
| `binary_sensor` | `occupancy`   | Detect room occupancy              |
| `sensor`        | `illuminance` | Light level measurement            |
| `media_player`  | *(any)*       | Detect media activity              |
| `light`         | *(any)*       | Learn manual control patterns      |

**Note**: Entities must be assigned to a room (area) in Home Assistant to be monitored.

### Activity-Based Light Learning Details

The light learning feature captures all manual light adjustments with activity context to understand user preferences:

- **Captured Actions:**
  - Turn on/off events
  - Brightness adjustments (0-255)
  - Color temperature changes (Kelvin or mired)
  - RGB color changes
  - HS (hue/saturation) color changes

- **Activity Context:**
  - Activity level at time of action (`empty`, `movement`, `occupied`)
  - Activity duration in seconds (how long the current activity has been ongoing)
  - Presence detection status (boolean)

- **Environmental Context:**
  - Illuminance level from sensors
  - Sun elevation (above/below horizon)
  - Time of day (hour 0-23)
  - Day of week (0=Monday, 6=Sunday)

- **Manual Detection:**
  - Only actions initiated by a user (not automations/scripts)
  - Requires `user_id` in Home Assistant event context
  - Automatically filters automated changes

- **Smart Switch Creation:**
  - Switches only created for areas with BOTH a light entity AND a movement sensor
  - Ensures automation switches are only available where activity tracking is possible

---

## 🛠️ Development & Testing

### Local Development Setup

1. **Clone the repository**:
   ```bash
   git clone https://github.com/Thank-you-Linus/Linus-Brain.git
   cd linus_brain
   ```

2. **Create a Home Assistant development environment**:
   ```bash
   # Using a virtual environment
   python3 -m venv venv
   source venv/bin/activate  # On Windows: venv\Scripts\activate
   
   # Install Home Assistant in dev mode
   pip install homeassistant
   ```

3. **Link the custom component**:
   ```bash
   mkdir -p ~/.homeassistant/custom_components
   ln -s $(pwd)/custom_components/linus_brain ~/.homeassistant/custom_components/linus_brain
   ```

4. **Start Home Assistant**:
   ```bash
   hass -c ~/.homeassistant
   ```

### Testing Checklist

- [ ] **Configuration Flow**
  - [ ] Can add integration via UI
  - [ ] Supabase connection validation works
  - [ ] Invalid credentials show error message
  
- [ ] **Entity Discovery**
  - [ ] Entities are correctly grouped by room
  - [ ] Only monitored domains/device classes are included
  - [ ] Entities without rooms are excluded
  
- [ ] **Data Collection**
  - [ ] Presence scores are calculated correctly
  - [ ] State changes trigger immediate updates
  - [ ] Heartbeat runs every 15 minutes
  - [ ] Data is sent to Supabase successfully
  
- [ ] **Diagnostic Sensors**
  - [ ] `sensor.linus_brain_last_sync` updates correctly
  - [ ] `sensor.linus_brain_monitored_rooms` shows correct count
  - [ ] `sensor.linus_brain_errors` tracks errors
  
- [ ] **Error Handling**
  - [ ] Network errors are logged but don't crash integration
  - [ ] Invalid Supabase responses are handled gracefully
  - [ ] Integration can be unloaded and reloaded

### Debug Logging

Enable debug logging by adding this to `configuration.yaml`:

```yaml
logger:
  default: info
  logs:
    custom_components.linus_brain: debug
```

---

## 🐛 Troubleshooting

### Issue: No data appears in Supabase

**Solution**:
1. Check that entities are assigned to rooms in Home Assistant
2. Verify Supabase credentials are correct
3. Check Home Assistant logs for connection errors
4. Ensure Supabase tables exist with correct schema

### Issue: Integration fails to load

**Solution**:
1. Check Home Assistant logs for error messages
2. Ensure `aiohttp` dependency is installed
3. Verify all files are in the correct directory structure
4. Restart Home Assistant after installation

### Issue: Entities not being discovered

**Solution**:
1. Verify entities have the correct device class
2. Ensure entities are assigned to an area/room
3. Check entity domains match monitored types
4. Review debug logs for discovery process

---

## 📝 File Structure

```
custom_components/linus_brain/
├── __init__.py              # Main integration setup
├── manifest.json            # Integration metadata
├── config_flow.py          # UI configuration flow
├── coordinator.py          # Data update coordinator
├── sensor.py               # Diagnostic sensor entities
├── switch.py               # Automation switch entities (activity-based)
├── services.py             # Custom services
└── utils/
    ├── activity_tracker.py # Activity level tracking (empty/movement/occupied)
    ├── area_manager.py     # Room/entity grouping logic
    ├── event_listener.py   # Real-time state change listener
    ├── light_learning.py   # Manual light action capture with activity context
    ├── supabase_client.py  # HTTP client for Supabase
    └── rule_engine.py      # AI rule application (placeholder)
```

---

## 🤝 Contributing

Contributions are welcome! Please:

1. Fork the repository
2. Create a feature branch: `git checkout -b feature/amazing-feature`
3. Commit your changes: `git commit -m 'Add amazing feature'`
4. Push to the branch: `git push origin feature/amazing-feature`
5. Open a Pull Request

---

## 📄 License

This project is licensed under the MIT License - see the [LICENSE](LICENSE) file for details.

---

## 🙏 Credits

- Created by [@Thank-you-Linus](https://github.com/Thank-you-Linus)
- Inspired by the vision of a self-learning smart home
- Built with ❤️ for the Home Assistant community

---

## 📞 Support

- **Issues**: [GitHub Issues](https://github.com/Thank-you-Linus/Linus-Brain/issues)
- **Discussions**: [GitHub Discussions](https://github.com/Thank-you-Linus/Linus-Brain/discussions)
- **Documentation**: [Wiki](https://github.com/Thank-you-Linus/Linus-Brain/wiki)

---

## 🗺️ Roadmap

### Phase 1: Data Collection (v0.1.0 - v0.1.3) ✅
- [x] Entity discovery and monitoring
- [x] Presence score computation
- [x] Supabase integration
- [x] Real-time and periodic updates
- [x] Light learning with manual action detection
- [x] Activity tracking (empty/movement/occupied)
- [x] Smart automation switch creation (eligible areas only)

### Phase 2: AI Integration (v0.2.0)
- [ ] AI agent for activity pattern analysis
- [ ] Rule generation based on activity transitions
- [ ] Confidence scoring system
- [ ] Rule application to automations with activity triggers

### Phase 3: User Experience (v0.3.0)
- [ ] Dashboard for activity pattern visualization
- [ ] Manual rule refinement UI
- [ ] Rule effectiveness tracking by activity level
- [ ] User feedback mechanism

### Phase 4: Advanced Features (v0.4.0)
- [ ] Multi-home support
- [ ] Seasonal pattern learning
- [ ] Activity-based energy optimization suggestions
- [ ] Integration with other AI platforms

---

**Linus Brain - Making your home smarter, one pattern at a time.** 🏠🧠
